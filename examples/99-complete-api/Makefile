.PHONY: help start stop setup clean dev backend frontend

help: ## Show this help message
	@echo "Vexilla Complete Demo - Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

start: ## Start all services (Flagr, Backend, Frontend)
	@echo "ğŸš€ Starting Vexilla Demo..."
	@echo ""
	@echo "1ï¸âƒ£  Starting Flagr..."
	@docker-compose up -d flagr
	@echo "â³ Waiting for Flagr to be ready..."
	@sleep 5
	@echo ""
	@echo "2ï¸âƒ£  Setting up flags..."
	@cd scripts && chmod +x setup-flags.sh && ./setup-flags.sh
	@echo ""
	@echo "3ï¸âƒ£  Starting backend..."
	@cd backend && go run main.go &
	@echo ""
	@echo "4ï¸âƒ£  Starting frontend..."
	@cd frontend && npm run dev
	@echo ""
	@echo "âœ… All services started!"
	@echo "ğŸ“Š Flagr UI:    http://localhost:18000"
	@echo "ğŸ”Œ Backend API: http://localhost:8080"
	@echo "ğŸ¨ Frontend:    http://localhost:3000"

stop: ## Stop all services
	@echo "ğŸ›‘ Stopping all services..."
	@docker-compose down
	@pkill -f "go run main.go" || true
	@pkill -f "next dev" || true
	@echo "âœ… All services stopped"

setup: ## Setup flags in Flagr
	@echo "ğŸ—ï¸  Setting up flags..."
	@cd scripts && chmod +x setup-flags.sh && ./setup-flags.sh

clean: ## Clean up Docker volumes and build artifacts
	@echo "ğŸ§¹ Cleaning up..."
	@docker-compose down -v
	@rm -rf backend/tmp
	@rm -rf frontend/.next
	@rm -rf frontend/node_modules
	@echo "âœ… Cleanup complete"

flagr: ## Start only Flagr
	@echo "ğŸ´ Starting Flagr..."
	@docker-compose up -d flagr
	@echo "âœ… Flagr started on http://localhost:18000"

backend: ## Start only backend
	@echo "ğŸ”Œ Starting backend..."
	@cd backend && go run main.go

frontend: ## Start only frontend
	@echo "ğŸ¨ Starting frontend..."
	@cd frontend && npm run dev

dev: ## Development mode (start Flagr + setup flags)
	@echo "ğŸ› ï¸  Development mode"
	@docker-compose up -d flagr
	@sleep 5
	@cd scripts && chmod +x setup-flags.sh && ./setup-flags.sh
	@echo ""
	@echo "âœ… Ready for development!"
	@echo ""
	@echo "Run these in separate terminals:"
	@echo "  Terminal 1: make backend"
	@echo "  Terminal 2: make frontend"

logs: ## Show Flagr logs
	@docker-compose logs -f flagr

test-checkout: ## Test checkout endpoint with different CPFs
	@echo "Testing checkout with different CPFs..."
	@echo ""
	@echo "CPF 1: 12345678909"
	@curl -X POST http://localhost:8080/checkout -H "X-User-ID: user-1" -H "X-CPF: 12345678909" | jq
	@echo ""
	@echo "CPF 2: 98765432100"
	@curl -X POST http://localhost:8080/checkout -H "X-User-ID: user-2" -H "X-CPF: 98765432100" | jq
	@echo ""
	@echo "CPF 3: 11122233344"
	@curl -X POST http://localhost:8080/checkout -H "X-User-ID: user-3" -H "X-CPF: 11122233344" | jq

health: ## Check health of all services
	@echo "ğŸ¥ Health Check"
	@echo ""
	@echo "Flagr:"
	@curl -s http://localhost:18000/api/v1/health | jq || echo "âŒ Flagr not running"
	@echo ""
	@echo "Backend:"
	@curl -s http://localhost:8080/health | jq || echo "âŒ Backend not running"
	@echo ""
	@echo "Frontend:"
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 && echo " âœ… Frontend running" || echo "âŒ Frontend not running"
